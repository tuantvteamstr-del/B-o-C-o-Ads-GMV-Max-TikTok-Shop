<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GMV Max V7 - Mobile Optimized</title>
    
    <!-- Libraries (Updated for Stability) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Base Settings */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* Tab Styles */
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; background-color: #eff6ff; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { color: #374151; background-color: #f9fafb; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Logic Styles */
        .editing-row { background-color: #fff7ed !important; border-left: 4px solid #f97316; }
        .sku-block { transition: all 0.3s ease; border: 1px solid #e5e7eb; }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 100; left: 50%; bottom: 20px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.3s, bottom 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }

        /* Mobile Adjustments */
        @media (max-width: 640px) {
            .index-badge { width: 20px; height: 20px; font-size: 10px; line-height: 20px; }
            input, select { font-size: 16px !important; } /* Prevent iOS zoom */
        }
    </style>
</head>
<body class="pb-10">

    <!-- Notification Toast -->
    <div id="toast"><i class="fa-solid fa-check-circle mr-2 text-green-400"></i> <span id="toastMsg">Th√¥ng b√°o</span></div>

    <!-- Hidden File Input -->
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center py-3 md:h-20 gap-3">
                <!-- Logo & Title -->
                <div class="flex items-center w-full md:w-auto justify-between md:justify-start">
                    <div class="flex items-center">
                        <div class="bg-black text-white p-2 rounded mr-3">
                            <i class="fa-brands fa-tiktok text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-lg md:text-xl font-bold text-gray-900 leading-tight">GMV Max V7</h1>
                            <p class="text-[10px] md:text-xs text-gray-500">Mobile Optimized ‚Ä¢ Auto-Save</p>
                        </div>
                    </div>
                    <!-- Mobile Action Menu Toggle could go here -->
                </div>
                
                <!-- Controls -->
                <div class="flex flex-col sm:flex-row items-center w-full md:w-auto gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                    <div class="flex w-full sm:w-auto gap-2">
                        <div class="flex-1 sm:w-40">
                            <select id="globalShopFilter" onchange="updateCampFilter(); renderAll()" class="w-full bg-white border border-gray-300 text-gray-800 text-xs md:text-sm rounded focus:ring-blue-500 focus:border-blue-500 p-2 font-semibold h-10">
                                <option value="all">üè¢ T·∫•t c·∫£ Shop</option>
                                <option value="Shop A">Shop A</option>
                                <option value="Shop B">Shop B</option>
                                <option value="Shop C">Shop C</option>
                            </select>
                        </div>
                        <div class="flex-1 sm:w-48">
                            <select id="globalCampFilter" onchange="renderAll()" class="w-full bg-white border border-gray-300 text-gray-800 text-xs md:text-sm rounded focus:ring-blue-500 focus:border-blue-500 p-2 font-medium truncate h-10">
                                <option value="all">üìä T·∫•t c·∫£ Camp</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex w-full sm:w-auto justify-between sm:justify-end gap-2 border-t sm:border-t-0 pt-2 sm:pt-0 border-gray-200">
                        <button onclick="exportData()" class="flex-1 sm:flex-none bg-green-100 text-green-700 p-2 rounded hover:bg-green-200 h-10 w-10 flex items-center justify-center" title="Backup Data">
                            <i class="fa-solid fa-download"></i>
                        </button>
                        <button onclick="document.getElementById('importFile').click()" class="flex-1 sm:flex-none bg-yellow-100 text-yellow-700 p-2 rounded hover:bg-yellow-200 h-10 w-10 flex items-center justify-center" title="Restore Data">
                            <i class="fa-solid fa-upload"></i>
                        </button>
                        <button onclick="clearData()" class="flex-1 sm:flex-none bg-red-100 text-red-700 p-2 rounded hover:bg-red-200 h-10 w-10 flex items-center justify-center" title="Reset All">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8 py-4">
        
        <!-- Navigation Tabs (Scrollable on Mobile) -->
        <div class="border-b border-gray-200 mb-4 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <nav class="flex space-x-1 min-w-full" aria-label="Tabs">
                <button onclick="switchTab('input')" id="tab-input" class="tab-active flex-1 py-3 px-4 text-center border-b-2 font-medium text-sm">
                    <i class="fa-solid fa-pen-to-square mr-1"></i> Nh·∫≠p Li·ªáu
                </button>
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-inactive flex-1 py-3 px-4 text-center border-b-2 border-transparent font-medium text-sm">
                    <i class="fa-solid fa-chart-pie mr-1"></i> T·ªïng Quan
                </button>
                <button onclick="switchTab('product')" id="tab-product" class="tab-inactive flex-1 py-3 px-4 text-center border-b-2 border-transparent font-medium text-sm">
                    <i class="fa-solid fa-shirt mr-1"></i> SKU
                </button>
                <button onclick="switchTab('campaign')" id="tab-campaign" class="tab-inactive flex-1 py-3 px-4 text-center border-b-2 border-transparent font-medium text-sm">
                    <i class="fa-solid fa-layer-group mr-1"></i> Camp
                </button>
                <button onclick="switchTab('creative')" id="tab-creative" class="tab-inactive flex-1 py-3 px-4 text-center border-b-2 border-transparent font-medium text-sm">
                    <i class="fa-solid fa-video mr-1"></i> Video
                </button>
            </nav>
        </div>

        <!-- TAB 1: DATA INPUT -->
        <div id="content-input" class="block">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Form Area -->
                <div class="lg:col-span-5 bg-white p-4 rounded-lg shadow-sm border-t-4 border-blue-600 h-fit">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-lg font-bold text-gray-800" id="formTitle">Th√™m D·ªØ Li·ªáu</h2>
                        <button onclick="resetForm()" id="btnCancelEdit" class="hidden text-xs text-red-500 font-medium bg-red-50 px-2 py-1 rounded">H·ªßy s·ª≠a</button>
                    </div>
                    
                    <form id="dataForm" onsubmit="handleFormSubmit(event)">
                        <input type="hidden" id="inputId">

                        <!-- Context Block -->
                        <div class="bg-gray-50 p-3 rounded-md mb-4 border border-gray-200">
                            <label class="block text-xs font-bold text-blue-800 uppercase mb-2">1. Th√¥ng tin Chung</label>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-500 uppercase">Ng√†y</label>
                                    <input type="date" id="inputDate" required class="w-full text-sm border-gray-300 rounded focus:ring-blue-500 border p-2 h-10">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-medium text-gray-500 uppercase">Shop</label>
                                    <select id="inputShop" class="w-full text-sm border-gray-300 rounded focus:ring-blue-500 border p-2 h-10 bg-white">
                                        <option value="Shop A">Shop A</option>
                                        <option value="Shop B">Shop B</option>
                                        <option value="Shop C">Shop C</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="block text-[10px] font-medium text-gray-500 uppercase">T√™n Chi·∫øn D·ªãch</label>
                                <input type="text" id="inputCampName" list="listCampNames" placeholder="Nh·∫≠p t√™n Camp..." required class="w-full text-sm border-gray-300 rounded focus:ring-blue-500 border p-2 h-10 font-semibold text-gray-800">
                                <datalist id="listCampNames"></datalist>
                            </div>
                            <div>
                                <label class="block text-[10px] font-medium text-gray-500 uppercase">Lo·∫°i Camp</label>
                                <select id="inputCampType" class="w-full text-sm border-gray-300 rounded focus:ring-blue-500 border p-2 h-10 bg-white">
                                    <option value="Multi-SKU">D·∫°ng 1: Multi-SKU (Nhi·ªÅu m√£)</option>
                                    <option value="Single-SKU">D·∫°ng 2: Single-SKU (1 m√£)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Metrics Container -->
                        <div class="mb-4">
                            <div class="flex justify-between items-end mb-2">
                                <label class="text-xs font-bold text-green-800 uppercase">2. Ch·ªâ S·ªë (Metrics)</label>
                            </div>
                            
                            <!-- Dynamic Blocks -->
                            <div id="metricsContainer" class="space-y-4 max-h-[60vh] overflow-y-auto pr-1 pb-2">
                                <!-- Initial Block -->
                                <div class="sku-block bg-white p-3 rounded-md shadow-sm relative pt-5">
                                    <div class="absolute -left-1 -top-1 bg-blue-600 text-white text-[10px] w-6 h-6 flex items-center justify-center rounded-full font-bold z-10 index-badge shadow-md">1</div>
                                    
                                    <div class="mb-3">
                                        <label class="block text-[10px] text-gray-500">SKU Name</label>
                                        <input type="text" name="sku" list="listSkus" placeholder="Ch·ªçn s·∫£n ph·∫©m..." required class="w-full text-sm border-gray-300 rounded border p-2 h-10 bg-green-50 font-medium">
                                    </div>
                                    <div class="mb-3">
                                        <label class="block text-[10px] text-gray-500">Video ID</label>
                                        <input type="text" name="video" list="listVideos" placeholder="Nh·∫≠p ID Video..." required class="w-full text-sm border-gray-300 rounded border p-2 h-10">
                                    </div>
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-[10px] text-gray-500">Cost ($)</label>
                                            <input type="number" name="cost" step="0.01" placeholder="0.00" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right font-mono text-red-600 font-bold">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-gray-500">GMV ($)</label>
                                            <input type="number" name="gmv" step="0.01" placeholder="0.00" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right font-mono text-green-600 font-bold">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label class="block text-[10px] text-gray-500">Orders</label>
                                            <input type="number" name="purchases" placeholder="0" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-gray-500">Impressions</label>
                                            <input type="number" name="impressions" placeholder="0" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="block text-[10px] text-gray-500">Clicks</label>
                                            <input type="number" name="clicks" placeholder="0" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] text-gray-500">2s Views</label>
                                            <input type="number" name="views2s" placeholder="0" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right">
                                        </div>
                                        <div>
                                            <label class="block text-[10px] font-bold text-blue-600">3s Views</label>
                                            <input type="number" name="views3s" placeholder="0" required class="w-full text-sm border-blue-300 bg-blue-50 rounded border p-2 h-10 text-right font-semibold">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Add Button -->
                            <button type="button" id="btnAddSku" onclick="addSkuBlock()" class="mt-3 w-full border-2 border-dashed border-gray-300 text-gray-600 font-bold py-3 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition flex items-center justify-center active:bg-gray-100">
                                <i class="fa-solid fa-plus-circle mr-2 text-lg"></i> Th√™m SKU kh√°c
                            </button>
                        </div>

                        <!-- Submit -->
                        <button type="submit" id="btnSubmit" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-lg hover:bg-blue-700 active:bg-blue-800 transition shadow-lg flex justify-center items-center text-sm uppercase tracking-wide sticky bottom-0 z-10">
                            <i class="fa-solid fa-floppy-disk mr-2 text-lg"></i> L∆∞u D·ªØ Li·ªáu
                        </button>
                    </form>
                </div>

                <!-- Raw Data Table -->
                <div class="lg:col-span-7 bg-white p-4 rounded-lg shadow-sm overflow-hidden flex flex-col h-[600px] lg:h-[900px] mt-4 lg:mt-0">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">L·ªãch s·ª≠ nh·∫≠p li·ªáu</h2>
                        <span id="recordCount" class="text-xs font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full">0</span>
                    </div>
                    
                    <div class="overflow-auto flex-1 border rounded-lg relative">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-3 py-3 text-left text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">Date/Shop</th>
                                    <th class="px-3 py-3 text-left text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">Campaign</th>
                                    <th class="px-3 py-3 text-left text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">SKU Info</th>
                                    <th class="px-3 py-3 text-right text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">Perf ($)</th>
                                    <th class="px-3 py-3 text-center text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">Action</th>
                                </tr>
                            </thead>
                            <tbody id="rawDataTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Global Datalists -->
            <datalist id="listCampNames"></datalist>
            <datalist id="listSkus"></datalist>
            <datalist id="listVideos"></datalist>
        </div>

        <!-- TAB 2: OVERVIEW -->
        <div id="content-overview" class="hidden pb-20">
            <!-- Filter Info -->
            <div class="mb-4 bg-white p-3 rounded shadow-sm border border-blue-100">
                <div class="text-xs text-gray-500 uppercase font-bold mb-1">ƒêang xem b√°o c√°o:</div>
                <div class="text-sm font-bold text-blue-700 flex items-center">
                    <i class="fa-solid fa-filter mr-2"></i> <span id="viewContext">Loading...</span>
                </div>
            </div>

            <!-- SHOP PERFORMANCE CARDS -->
            <div class="mb-6">
                 <h3 class="text-xs font-bold text-gray-500 mb-3 uppercase flex items-center">
                    <i class="fa-solid fa-store mr-2"></i> Hi·ªáu Su·∫•t K√™nh
                </h3>
                <div id="shopPerformanceContainer" class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <!-- Cards injected here -->
                </div>
            </div>

            <!-- Dashboard Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Winners -->
                <div class="bg-white p-4 rounded-lg shadow-sm border border-green-100">
                    <h3 class="text-xs font-bold text-gray-700 mb-3 uppercase flex items-center">
                        <i class="fa-solid fa-trophy text-yellow-500 mr-2"></i> Top Winners (ROI > 0)
                    </h3>
                    <div class="overflow-y-auto max-h-56">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-50 text-gray-500 sticky top-0"><tr><th class="p-2 text-left">SKU</th><th class="p-2 text-right">Profit</th><th class="p-2 text-center">ROI</th></tr></thead>
                            <tbody id="topSkuBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Losers -->
                <div class="bg-white p-4 rounded-lg shadow-sm border border-red-100">
                    <h3 class="text-xs font-bold text-gray-700 mb-3 uppercase flex items-center">
                        <i class="fa-solid fa-triangle-exclamation text-red-500 mr-2"></i> C·∫ßn T·ªëi ∆Øu (ROI < 0)
                    </h3>
                    <div class="overflow-y-auto max-h-56">
                        <table class="w-full text-xs">
                            <thead class="bg-gray-50 text-gray-500 sticky top-0"><tr><th class="p-2 text-left">SKU</th><th class="p-2 text-right">Loss</th><th class="p-2 text-center">ROI</th></tr></thead>
                            <tbody id="badSkuBody"></tbody>
                        </table>
                    </div>
                </div>

                 <!-- Pie Chart -->
                 <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex flex-col items-center">
                    <h3 class="text-xs font-bold text-gray-700 mb-2 uppercase">T·ª∑ tr·ªçng chi ph√≠ (Cost)</h3>
                    <div class="relative w-full h-48">
                        <canvas id="chartPie"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Trend Chart -->
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="text-xs font-bold text-gray-700 mb-4 uppercase">Xu h∆∞·ªõng ROI theo ng√†y</h3>
                <div class="h-60 w-full relative">
                    <canvas id="chartTrend"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB 3: PRODUCT ANALYSIS -->
        <div id="content-product" class="hidden">
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h2 class="text-lg font-bold text-gray-800">Ph√¢n T√≠ch SKU</h2>
                    
                    <div class="flex bg-gray-100 p-1 rounded-lg w-full sm:w-auto">
                        <button onclick="setSkuMode('global')" id="btnSkuGlobal" class="flex-1 px-3 py-2 text-xs font-bold rounded shadow bg-white text-blue-600 transition">To√†n H·ªá Th·ªëng</button>
                        <button onclick="setSkuMode('detailed')" id="btnSkuDetailed" class="flex-1 px-3 py-2 text-xs font-bold rounded text-gray-500 transition">Theo Camp</button>
                    </div>
                </div>

                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">SKU</th>
                                <th id="colCampName" class="px-3 py-3 text-left text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap hidden">Camp</th>
                                <th class="px-3 py-3 text-right text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">Cost</th>
                                <th class="px-3 py-3 text-right text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">GMV</th>
                                <th class="px-3 py-3 text-center text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">Orders</th>
                                <th class="px-3 py-3 text-center text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">ROI</th>
                                <th class="px-3 py-3 text-left text-[10px] font-bold text-gray-500 uppercase whitespace-nowrap">Action</th>
                            </tr>
                        </thead>
                        <tbody id="skuTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 4: CAMPAIGN HEALTH -->
        <div id="content-campaign" class="hidden pb-20">
            <div id="campaignHealthContainer" class="space-y-6"></div>
        </div>

        <!-- TAB 5: VIDEO VIRAL -->
        <div id="content-creative" class="hidden pb-20">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow-sm">
                    <h3 class="text-sm font-bold text-gray-800 mb-2">Ma tr·∫≠n Video (Scatter Plot)</h3>
                    <div class="h-64 sm:h-80 w-full relative">
                        <canvas id="chartVideoScatter"></canvas>
                    </div>
                </div>
                
                <div class="lg:col-span-1 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col h-[500px]">
                    <div class="p-3 bg-gray-50 border-b flex flex-col gap-2">
                        <h3 class="text-sm font-bold text-gray-800">X·∫øp h·∫°ng Video</h3>
                        <select id="videoSort" onchange="renderCreativeAnalysis()" class="text-xs border border-gray-300 rounded p-2 bg-white w-full">
                            <option value="viral3s">üî• Top 3s Views (Gi·ªØ ch√¢n)</option>
                            <option value="viral">üëÄ Top Views T·ªïng</option>
                            <option value="spend">üí∞ Top Spend (Chi ti√™u)</option>
                            <option value="roas">üíé Top ROAS (Hi·ªáu qu·∫£)</option>
                        </select>
                    </div>
                    <div class="overflow-y-auto flex-1 p-2 space-y-2 bg-gray-50" id="videoList"></div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- 1. CONFIG & STATE ---
        let appData = [];
        try {
            const stored = localStorage.getItem('gmv_max_data');
            if (stored) appData = JSON.parse(stored);
        } catch (e) {
            console.error("Local Storage Error", e);
            appData = [];
        }
        
        let editingId = null;
        let skuMode = 'global';
        const tabs = ['input', 'overview', 'product', 'campaign', 'creative'];
        let charts = {};

        // Helper: Currency
        const formatMoney = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
        const formatNum = (num) => new Intl.NumberFormat('en-US').format(num);

        // --- 2. INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('inputDate');
            if(dateInput) dateInput.valueAsDate = new Date();
            renderAll();
            updateDatalists();
        });

        // --- 3. STORAGE ---
        function saveData() {
            try {
                localStorage.setItem('gmv_max_data', JSON.stringify(appData));
                showToast("ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng!");
            } catch (e) {
                alert("L·ªói: B·ªô nh·ªõ tr√¨nh duy·ªát ƒë√£ ƒë·∫ßy. H√£y xu·∫•t file Backup v√† x√≥a b·ªõt d·ªØ li·ªáu c≈©.");
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.className = "show";
            setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
        }

        // --- 4. CORE LOGIC ---
        function handleFormSubmit(e) {
            e.preventDefault();
            
            // Get Context
            const date = document.getElementById('inputDate').value;
            const shop = document.getElementById('inputShop').value;
            const campName = document.getElementById('inputCampName').value;
            const campType = document.getElementById('inputCampType').value;

            if(!date || !shop || !campName) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin chung"); return; }

            const blocks = document.querySelectorAll('.sku-block');
            const newRecords = [];

            for (const block of blocks) {
                const sku = block.querySelector('[name="sku"]').value.trim();
                if(!sku) continue;

                // Constraint Check
                if (!editingId) {
                    const conflict = appData.find(i => i.sku === sku && i.shop === shop && i.date === date && i.campName !== campName);
                    if (conflict) {
                        if (!confirm(`‚ö†Ô∏è C·∫¢NH B√ÅO: SKU "${sku}" ƒë√£ ch·∫°y ·ªü Camp "${conflict.campName}". Ti·∫øp t·ª•c th√™m?`)) continue;
                    }
                }

                newRecords.push({
                    id: editingId || Date.now() + Math.random(),
                    date, shop, campName, campType, sku,
                    video: block.querySelector('[name="video"]').value || '',
                    cost: parseFloat(block.querySelector('[name="cost"]').value) || 0,
                    gmv: parseFloat(block.querySelector('[name="gmv"]').value) || 0,
                    purchases: parseInt(block.querySelector('[name="purchases"]').value) || 0,
                    impressions: parseInt(block.querySelector('[name="impressions"]').value) || 0,
                    clicks: parseInt(block.querySelector('[name="clicks"]').value) || 0,
                    views2s: parseInt(block.querySelector('[name="views2s"]').value) || 0,
                    views3s: parseInt(block.querySelector('[name="views3s"]').value) || 0,
                });
            }

            if (newRecords.length === 0) { alert("Ch∆∞a nh·∫≠p d·ªØ li·ªáu SKU n√†o!"); return; }

            if (editingId) {
                const idx = appData.findIndex(i => i.id === editingId);
                if (idx !== -1) appData[idx] = newRecords[0];
                resetForm();
            } else {
                appData.push(...newRecords);
                // Reset metrics only, keep context for fast entry
                const container = document.getElementById('metricsContainer');
                while(container.children.length > 1) container.removeChild(container.lastChild);
                // Clear inputs in the first block
                const firstBlock = container.children[0];
                firstBlock.querySelectorAll('input').forEach(i => i.value = '');
            }

            saveData();
            renderAll();
            updateDatalists();
        }

        // --- 5. RENDER FUNCTIONS ---
        function renderAll() {
            renderInputTable();
            renderOverview();
            renderProductAnalysis();
            renderCampaignHealth();
            renderCreativeAnalysis();
            
            // Update Context Label
            const s = document.getElementById('globalShopFilter').value;
            const c = document.getElementById('globalCampFilter').value;
            let txt = s === 'all' ? 'T·∫•t c·∫£ Shop' : s;
            if(c !== 'all') txt += ` > ${c}`;
            document.getElementById('viewContext').innerText = txt;
        }

        function getFilteredData() {
            const s = document.getElementById('globalShopFilter').value;
            const c = document.getElementById('globalCampFilter').value;
            let d = appData;
            if (s !== 'all') d = d.filter(i => i.shop === s);
            if (c !== 'all') d = d.filter(i => i.campName === c);
            return d;
        }

        // --- Render Input Table ---
        function renderInputTable() {
            const data = getFilteredData().sort((a,b) => b.id - a.id).slice(0, 50);
            const tbody = document.getElementById('rawDataTableBody');
            document.getElementById('recordCount').innerText = data.length;
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const isEditing = editingId === item.id;
                tbody.innerHTML += `
                    <tr class="${isEditing ? 'editing-row' : ''} border-b hover:bg-gray-50 transition">
                        <td class="px-3 py-2">
                            <div class="text-[10px] text-gray-500">${item.date}</div>
                            <div class="text-xs font-bold text-gray-800">${item.shop}</div>
                        </td>
                        <td class="px-3 py-2">
                            <div class="text-xs font-medium text-blue-700 truncate w-24 sm:w-32" title="${item.campName}">${item.campName}</div>
                            <span class="text-[9px] px-1.5 py-0.5 rounded bg-gray-100 border border-gray-200">${item.campType === 'Multi-SKU' ? 'Multi' : 'Single'}</span>
                        </td>
                        <td class="px-3 py-2">
                            <div class="text-xs font-bold text-gray-700 truncate w-20 sm:w-24">${item.sku}</div>
                            <div class="text-[9px] text-gray-400 truncate w-20 sm:w-24">${item.video}</div>
                        </td>
                        <td class="px-3 py-2 text-right">
                            <div class="text-xs font-bold text-green-600">${formatMoney(item.gmv)}</div>
                            <div class="text-[10px] text-red-500">-${formatMoney(item.cost)}</div>
                        </td>
                        <td class="px-3 py-2 text-center">
                             <button onclick="editRow(${item.id})" class="text-blue-500 p-2"><i class="fa-solid fa-pen"></i></button>
                             <button onclick="deleteRow(${item.id})" class="text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- Render Overview ---
        function renderOverview() {
            const data = getFilteredData();
            const container = document.getElementById('shopPerformanceContainer');
            container.innerHTML = '';
            
            ['Shop A', 'Shop B', 'Shop C'].forEach(s => {
                const shopItems = appData.filter(i => i.shop === s);
                const cost = shopItems.reduce((a,b) => a + b.cost, 0);
                const gmv = shopItems.reduce((a,b) => a + b.gmv, 0);
                const roi = cost > 0 ? (gmv - cost)/cost : 0;
                const roiColor = roi < 0 ? 'text-red-500' : (roi < 1.5 ? 'text-yellow-600' : 'text-green-600');
                
                container.innerHTML += `
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-sm text-gray-800">${s}</span>
                            <span class="text-xs font-bold ${roiColor} bg-gray-50 px-2 py-1 rounded">ROI: ${roi.toFixed(2)}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="text-gray-500">Cost: <span class="text-gray-900 font-mono">${formatMoney(cost)}</span></div>
                            <div class="text-gray-500 text-right">GMV: <span class="text-gray-900 font-mono">${formatMoney(gmv)}</span></div>
                        </div>
                    </div>
                `;
            });

            // Charts & Tables (Simplified for brevity but functional)
            // Pie Chart
            const ctxPie = document.getElementById('chartPie').getContext('2d');
            if(charts.pie) charts.pie.destroy();
            const shopCosts = ['Shop A', 'Shop B', 'Shop C'].map(s => appData.filter(i => i.shop === s).reduce((a,b) => a + b.cost, 0));
            charts.pie = new Chart(ctxPie, {
                type: 'doughnut',
                data: { labels: ['Shop A', 'Shop B', 'Shop C'], datasets: [{ data: shopCosts, backgroundColor: ['#3b82f6', '#ef4444', '#10b981'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });

            // Trend Chart
            const ctxTrend = document.getElementById('chartTrend').getContext('2d');
            if(charts.trend) charts.trend.destroy();
            const dates = [...new Set(data.map(i => i.date))].sort();
            const trends = dates.map(d => {
                const dayData = data.filter(i => i.date === d);
                const c = dayData.reduce((a,b) => a + b.cost, 0);
                const g = dayData.reduce((a,b) => a + b.gmv, 0);
                return c > 0 ? (g-c)/c : 0;
            });
            charts.trend = new Chart(ctxTrend, {
                type: 'line',
                data: { labels: dates, datasets: [{ label: 'ROI', data: trends, borderColor: '#2563eb', tension: 0.3, fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false } } }
            });

            // Top/Bad SKUs
            const skuMap = {};
            data.forEach(i => {
                if(!skuMap[i.sku]) skuMap[i.sku] = { sku: i.sku, cost: 0, gmv: 0 };
                skuMap[i.sku].cost += i.cost; skuMap[i.sku].gmv += i.gmv;
            });
            const skus = Object.values(skuMap).map(s => ({...s, roi: s.cost > 0 ? (s.gmv - s.cost)/s.cost : -1, profit: s.gmv - s.cost}));
            
            document.getElementById('topSkuBody').innerHTML = skus.filter(s => s.roi > 0).sort((a,b) => b.roi - a.roi).slice(0, 5).map(s => `
                <tr class="border-b"><td class="p-2 truncate max-w-[80px] font-medium">${s.sku}</td><td class="p-2 text-right text-green-600">+${formatMoney(s.profit)}</td><td class="p-2 text-center text-green-600 font-bold">${s.roi.toFixed(2)}</td></tr>
            `).join('');
            
            document.getElementById('badSkuBody').innerHTML = skus.filter(s => s.roi < 0).sort((a,b) => a.roi - b.roi).slice(0, 5).map(s => `
                <tr class="border-b"><td class="p-2 truncate max-w-[80px] font-medium">${s.sku}</td><td class="p-2 text-right text-red-500">${formatMoney(s.profit)}</td><td class="p-2 text-center text-red-500 font-bold">${s.roi.toFixed(2)}</td></tr>
            `).join('');
        }

        // --- Render Product ---
        function renderProductAnalysis() {
            const data = getFilteredData();
            const tbody = document.getElementById('skuTableBody');
            tbody.innerHTML = '';
            
            const map = {};
            data.forEach(i => {
                const k = skuMode === 'global' ? i.sku : `${i.sku}||${i.campName}`;
                if(!map[k]) map[k] = { sku: i.sku, camp: i.campName, cost: 0, gmv: 0, orders: 0 };
                map[k].cost += i.cost; map[k].gmv += i.gmv; map[k].orders += i.purchases;
            });

            Object.values(map).sort((a,b) => b.cost - a.cost).forEach(r => {
                const roi = r.cost > 0 ? (r.gmv - r.cost)/r.cost : -1;
                const advice = roi < 0 ? 'T·∫Øt' : (roi < 1.5 ? 'T·ªëi ∆∞u' : 'Scale');
                const color = roi < 0 ? 'text-red-500' : (roi < 1.5 ? 'text-yellow-600' : 'text-green-600');
                
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-3 py-3 text-xs font-bold text-gray-800">${r.sku}</td>
                        <td class="px-3 py-3 text-xs text-blue-600 ${skuMode==='detailed'?'':'hidden'}">${r.camp}</td>
                        <td class="px-3 py-3 text-right text-xs font-mono">${formatMoney(r.cost)}</td>
                        <td class="px-3 py-3 text-right text-xs font-mono">${formatMoney(r.gmv)}</td>
                        <td class="px-3 py-3 text-center text-xs">${r.orders}</td>
                        <td class="px-3 py-3 text-center text-xs font-bold ${color}">${roi.toFixed(2)}</td>
                        <td class="px-3 py-3 text-xs italic text-gray-500">${advice}</td>
                    </tr>
                `;
            });
        }

        // --- Render Campaign ---
        function renderCampaignHealth() {
            const data = getFilteredData();
            const container = document.getElementById('campaignHealthContainer');
            container.innerHTML = '';
            
            const shops = [...new Set(data.map(i => i.shop))];
            shops.forEach(s => {
                const shopData = data.filter(i => i.shop === s);
                if(!shopData.length) return;
                
                const campMap = {};
                shopData.forEach(i => {
                    if(!campMap[i.campName]) campMap[i.campName] = { name: i.campName, type: i.campType, cost: 0, gmv: 0 };
                    campMap[i.campName].cost += i.cost; campMap[i.campName].gmv += i.gmv;
                });

                let rows = Object.values(campMap).map(c => {
                    const roi = c.cost > 0 ? (c.gmv - c.cost)/c.cost : -1;
                    const color = roi < 0 ? 'text-red-500' : 'text-green-600';
                    return `
                        <tr class="border-b text-xs">
                            <td class="p-2 font-medium truncate max-w-[120px]">${c.name}</td>
                            <td class="p-2 text-center text-gray-500">${c.type==='Multi-SKU'?'M':'S'}</td>
                            <td class="p-2 text-right font-mono">${formatMoney(c.cost)}</td>
                            <td class="p-2 text-center font-bold ${color}">${roi.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');

                container.innerHTML += `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-3 py-2 border-b font-bold text-sm text-gray-800">${s}</div>
                        <table class="w-full">
                            <thead class="bg-gray-100 text-gray-500"><tr><th class="p-2 text-left text-[10px] uppercase">Camp</th><th class="p-2 text-center text-[10px] uppercase">Type</th><th class="p-2 text-right text-[10px] uppercase">Cost</th><th class="p-2 text-center text-[10px] uppercase">ROI</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            });
        }

        // --- Render Creative ---
        function renderCreativeAnalysis() {
            const data = getFilteredData();
            const sort = document.getElementById('videoSort').value;
            const map = {};
            data.forEach(i => {
                if(!map[i.video]) map[i.video] = { id: i.video, cost: 0, gmv: 0, imps: 0, v3s: 0 };
                map[i.video].cost += i.cost; map[i.video].gmv += i.gmv; map[i.video].imps += i.impressions; map[i.video].v3s += (i.views3s||0);
            });
            
            const vids = Object.values(map);
            
            // Scatter
            const ctxSc = document.getElementById('chartVideoScatter').getContext('2d');
            if(charts.sc) charts.sc.destroy();
            const sData = vids.map(v => ({ x: v.cost>0?v.gmv/v.cost:0, y: v.imps, r: Math.min(v.cost/10, 20) })).filter(d=>d.y>0);
            charts.sc = new Chart(ctxSc, {
                type: 'bubble',
                data: { datasets: [{ label: 'Video (Size=Cost)', data: sData, backgroundColor: 'rgba(59, 130, 246, 0.6)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: {display: true, text: 'ROAS'} }, y: { title: {display: true, text: 'Views'} } } }
            });

            // List
            let sorted = [];
            if(sort === 'viral3s') sorted = vids.sort((a,b) => b.v3s - a.v3s);
            else if(sort === 'viral') sorted = vids.sort((a,b) => b.imps - a.imps);
            else if(sort === 'spend') sorted = vids.sort((a,b) => b.cost - a.cost);
            else sorted = vids.sort((a,b) => (b.cost>0?b.gmv/b.cost:0) - (a.cost>0?a.gmv/a.cost:0));

            document.getElementById('videoList').innerHTML = sorted.slice(0, 50).map(v => {
                const roas = v.cost>0?v.gmv/v.cost:0;
                return `
                    <div class="bg-white p-2 rounded border border-gray-200 flex justify-between items-center">
                        <div class="overflow-hidden">
                            <div class="text-xs font-bold text-blue-800 truncate w-32">${v.id}</div>
                            <div class="text-[10px] text-gray-500">3s Views: <b>${formatNum(v.v3s)}</b></div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-500">Spend: ${formatMoney(v.cost)}</div>
                            <div class="text-xs font-bold ${roas>=2?'text-green-600':'text-orange-500'}">ROAS: ${roas.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- Helpers ---
        function addSkuBlock() {
            const container = document.getElementById('metricsContainer');
            const count = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'sku-block bg-white p-3 rounded-md shadow-sm relative pt-5 mt-4';
            div.innerHTML = `
                <div class="absolute -left-1 -top-1 bg-gray-600 text-white text-[10px] w-6 h-6 flex items-center justify-center rounded-full font-bold z-10 index-badge shadow-md">${count}</div>
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-red-400 p-2"><i class="fa-solid fa-times"></i></button>
                <div class="mb-3"><label class="block text-[10px] text-gray-500">SKU Name</label><input type="text" name="sku" list="listSkus" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 bg-green-50 font-medium"></div>
                <div class="mb-3"><label class="block text-[10px] text-gray-500">Video ID</label><input type="text" name="video" list="listVideos" required class="w-full text-sm border-gray-300 rounded border p-2 h-10"></div>
                <div class="grid grid-cols-2 gap-3 mb-3"><div><label class="block text-[10px] text-gray-500">Cost</label><input type="number" name="cost" step="0.01" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right font-mono text-red-600 font-bold"></div><div><label class="block text-[10px] text-gray-500">GMV</label><input type="number" name="gmv" step="0.01" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right font-mono text-green-600 font-bold"></div></div>
                <div class="grid grid-cols-2 gap-3 mb-3"><div><label class="block text-[10px] text-gray-500">Orders</label><input type="number" name="purchases" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right"></div><div><label class="block text-[10px] text-gray-500">Imp</label><input type="number" name="impressions" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right"></div></div>
                <div class="grid grid-cols-3 gap-2"><div><label class="block text-[10px] text-gray-500">Clicks</label><input type="number" name="clicks" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right"></div><div><label class="block text-[10px] text-gray-500">2s</label><input type="number" name="views2s" required class="w-full text-sm border-gray-300 rounded border p-2 h-10 text-right"></div><div><label class="block text-[10px] font-bold text-blue-600">3s</label><input type="number" name="views3s" required class="w-full text-sm border-blue-300 bg-blue-50 rounded border p-2 h-10 text-right font-semibold"></div></div>
            `;
            container.appendChild(div);
        }

        function switchTab(tab) {
            tabs.forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.replace('tab-inactive', 'tab-active');
            renderAll();
        }

        function updateCampFilter() {
            const s = document.getElementById('globalShopFilter').value;
            const camps = s === 'all' ? [...new Set(appData.map(i => i.campName))] : [...new Set(appData.filter(i => i.shop === s).map(i => i.campName))];
            document.getElementById('globalCampFilter').innerHTML = `<option value="all">üìä T·∫•t c·∫£ Camp</option>` + camps.sort().map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function setSkuMode(mode) {
            skuMode = mode;
            document.getElementById('btnSkuGlobal').className = mode === 'global' ? "flex-1 px-3 py-2 text-xs font-bold rounded shadow bg-white text-blue-600 transition" : "flex-1 px-3 py-2 text-xs font-bold rounded text-gray-500 transition";
            document.getElementById('btnSkuDetailed').className = mode === 'detailed' ? "flex-1 px-3 py-2 text-xs font-bold rounded shadow bg-white text-blue-600 transition" : "flex-1 px-3 py-2 text-xs font-bold rounded text-gray-500 transition";
            document.getElementById('colCampName').classList.toggle('hidden', mode !== 'detailed');
            renderProductAnalysis();
        }

        function updateDatalists() {
            document.getElementById('listCampNames').innerHTML = [...new Set(appData.map(i => i.campName))].map(v => `<option value="${v}">`).join('');
            document.getElementById('listSkus').innerHTML = [...new Set(appData.map(i => i.sku))].map(v => `<option value="${v}">`).join('');
            document.getElementById('listVideos').innerHTML = [...new Set(appData.map(i => i.video))].map(v => `<option value="${v}">`).join('');
        }

        function resetForm() {
            editingId = null; document.getElementById('dataForm').reset();
            document.getElementById('inputDate').valueAsDate = new Date();
            document.getElementById('formTitle').innerText = "Th√™m D·ªØ Li·ªáu";
            document.getElementById('btnCancelEdit').classList.add('hidden');
            const c = document.getElementById('metricsContainer');
            while(c.children.length > 1) c.removeChild(c.lastChild);
        }

        function editRow(id) {
            const item = appData.find(i => i.id === id);
            if(!item) return;
            document.getElementById('inputDate').value = item.date;
            document.getElementById('inputShop').value = item.shop;
            document.getElementById('inputCampName').value = item.campName;
            document.getElementById('inputCampType').value = item.campType;
            
            const c = document.getElementById('metricsContainer');
            while(c.children.length > 1) c.removeChild(c.lastChild);
            const b = c.children[0];
            
            b.querySelector('[name="sku"]').value = item.sku;
            b.querySelector('[name="video"]').value = item.video;
            b.querySelector('[name="cost"]').value = item.cost;
            b.querySelector('[name="gmv"]').value = item.gmv;
            b.querySelector('[name="purchases"]').value = item.purchases;
            b.querySelector('[name="impressions"]').value = item.impressions;
            b.querySelector('[name="clicks"]').value = item.clicks;
            b.querySelector('[name="views2s"]').value = item.views2s;
            b.querySelector('[name="views3s"]').value = item.views3s || 0;

            editingId = id;
            document.getElementById('formTitle').innerText = "S·ª≠a d·ªØ li·ªáu";
            document.getElementById('btnCancelEdit').classList.remove('hidden');
            switchTab('input');
        }

        function deleteRow(id) { if(confirm("X√≥a d√≤ng n√†y?")) { appData = appData.filter(i => i.id !== id); saveData(); renderAll(); updateDatalists(); } }
        function clearData() { if(confirm("X√≥a TO√ÄN B·ªò d·ªØ li·ªáu?")) { appData = []; saveData(); renderAll(); updateDatalists(); } }
        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            a.download = "gmv_max_backup.json";
            document.body.appendChild(a); a.click(); a.remove();
        }
        function importData(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => { 
                try { 
                    const d = JSON.parse(e.target.result); 
                    if(Array.isArray(d)) { appData = d; saveData(); renderAll(); updateDatalists(); alert("ƒê√£ nh·∫≠p d·ªØ li·ªáu!"); }
                } catch(err) { alert("File l·ªói!"); }
            };
            r.readAsText(f); input.value = '';
        }
    </script>
</body>
</html>
